{%- set token = get_env(name="DISCORD_TOKEN", default="NO_TOKEN") -%}
{%- set sgdb_token = get_env(name="STEAMGRIDDB_API_KEY", default="NO_TOKEN") -%}
{%- set user = config.extra.discord_user_id | default(value="NO_USER") -%}
{%- set widget_id = "1438359198198136863" -%}
{%- set x_super = '{"os":"Windows","client_build_number":472914}' | base64_encode -%}
{%- set parms = [
	"type=modal",
	"with_mutual_guilds=false",
	"with_mutual_friends=false",
	"with_mutual_friends_count=false"] | join(sep="&") -%}

{%- if token != "NO_TOKEN" and user != "NO_USER" -%}
	{%- set profile = load_data(
		url="https://discord.com/api/v10/users/" ~ user ~ "/profile?" ~ parms,
		format="json",
		method="GET",
		content_type="application/json",
		headers=[
			"authorization= " ~ token,
			"user-agent= DiscordBot (" ~ config.base_url ~ ", 0.1.0)",
			"x-super-properties= " ~ x_super
		])
	-%}

	{%- set played_games = profile.widgets | filter(attribute="id", value=widget_id) | first -%}
{%- endif -%}

{%- if token != "NO_TOKEN" and user != "NO_USER" and played_games -%}
	{%- if played_games.data.games | length > 8 -%}
		<input class="visually-hidden" id="show-more" type="checkbox" name="show-more" autocomplete="off" />
		<label for="show-more">
			<span class="more">Show More…</span>
			<span class="less">Show Less…</span>
		</label>
	{%- endif -%}

	<ul>
		{%- for game in played_games.data.games -%}
			{# All games past the first 8 are rendered inside of a separate <ul> #}
			{%- if loop.index == 9 -%}
	</ul>
	<ul class="games-extra">
			{%- endif -%}
			{%- set data = load_data(
				url="https://discord.com/api/v9/applications/public?application_ids=" ~ game.game_id,
				format="json",
				method="GET",
				content_type="application/json",
				headers=[
					"authorization= " ~ token,
					"user-agent= DiscordBot (" ~ config.base_url ~ ", 0.1.0)",
					"x-super-properties= " ~ x_super
				]) | first
			-%}
			{%- set steam = data.third_party_skus | filter(attribute="distributor", value="steam") | first -%}
			
			{# SteamGridDB Logic as Fallback #}
			{%- set sgdb_img = "" -%}
			{# Only attempt to fetch if we have a token AND the Steam image might fail (we can't know beforehand, so we fetch aggressively) #}
			{# Or, per your request, we use SGDB as fallback. Wait, usually Steam is faster/more reliable, but lacks some covers. #}
			{# "Use SteamGridDB but as Fallback" means: Try Steam first. If it breaks, use SGDB. #}
			
			{%- if sgdb_token != "NO_TOKEN" and steam -%}
				{# We fetch SGDB URL just in case we need it for onerror. Removed styles filter to prevent 400 Bad Request on specific games like Undertale #}
				{%- set sgdb_data = load_data(
					url="https://www.steamgriddb.com/api/v2/grids/steam/" ~ steam.id ~ "?dimensions=600x900&nsfw=false",
					format="json",
					method="GET",
					headers=["Authorization= Bearer " ~ sgdb_token],
					fail_on_error=false
				) -%}
				{%- if sgdb_data and sgdb_data.success and sgdb_data.data | length > 0 -%}
					{%- set sgdb_img = sgdb_data.data[0].url -%}
				{%- endif -%}
			{%- endif -%}

			{%- if sgdb_token != "NO_TOKEN" and not steam -%}
				{# Search by name if not on Steam #}
				{%- set search_query = data.name | urlencode -%}
				{%- set sgdb_search = load_data(
					url="https://www.steamgriddb.com/api/v2/search/autocomplete/" ~ search_query,
					format="json",
					method="GET",
					headers=["Authorization= Bearer " ~ sgdb_token],
					fail_on_error=false
				) -%}

				{%- if sgdb_search and sgdb_search.success and sgdb_search.data | length > 0 -%}
					{%- set game_id = sgdb_search.data[0].id -%}
					{%- set sgdb_data = load_data(
						url="https://www.steamgriddb.com/api/v2/grids/game/" ~ game_id ~ "?dimensions=600x900&nsfw=false",
						format="json",
						method="GET",
						headers=["Authorization= Bearer " ~ sgdb_token],
						fail_on_error=false
					) -%}
					{%- if sgdb_data and sgdb_data.success and sgdb_data.data | length > 0 -%}
						{%- set sgdb_img = sgdb_data.data[0].url -%}
					{%- endif -%}
				{%- endif -%}
			{%- endif -%}

			{%- if steam or sgdb_img -%}
			<li>
				<a href="{% if steam %}https://store.steampowered.com/app/{{ steam.id }}{% else %}#{% endif %}">
					{%- set steam_img = "" -%}
					{%- if steam -%}
						{%- set steam_img = "https://shared.steamstatic.com/store_item_assets/steam/apps/" ~ steam.id ~ "/library_600x900.jpg" -%}
					{%- endif -%}
					
					<img
						class="transparent no-hover"
						alt="Capsule art of {{ data.name }}."
						{% if steam_img %}
							src="{{ steam_img }}"
						{% else %}
							src="{{ sgdb_img }}"
						{% endif %}
						{% if steam_img and sgdb_img %}
							onerror="this.onerror=null;this.src='{{ sgdb_img }}';"
						{% endif %}
						{% if config.markdown.lazy_async_image %}
							decoding="async" loading="lazy"
						{% endif %}
					/>
				</a>
			</li>
			{%- endif -%}
		{%- endfor -%}
	</ul>
{%- else -%}
	<p><em>(Games list unavailable - Discord Token missing or widget not found)</em></p>
	<!-- Fallback or empty list to prevent build errors -->
{%- endif -%}
