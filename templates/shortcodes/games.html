{%- set token = get_env(name="DISCORD_TOKEN", default="NO_TOKEN") -%}
{%- set sgdb_token = get_env(name="STEAMGRIDDB_API_KEY", default="NO_TOKEN") -%}
{%- set user = config.extra.discord_user_id | default(value="NO_USER") -%}
{%- set widget_id = "1438359198198136863" -%}
{%- set x_super = '{"os":"Windows","client_build_number":472914}' | base64_encode -%}
{%- set parms = [
	"type=modal",
	"with_mutual_guilds=false",
	"with_mutual_friends=false",
	"with_mutual_friends_count=false"] | join(sep="&") -%}

{%- if token != "NO_TOKEN" and user != "NO_USER" -%}
	{%- set profile = load_data(
		url="https://discord.com/api/v10/users/" ~ user ~ "/profile?" ~ parms,
		format="json",
		method="GET",
		content_type="application/json",
		headers=[
			"authorization= " ~ token,
			"user-agent= DiscordBot (" ~ config.base_url ~ ", 0.1.0)",
			"x-super-properties= " ~ x_super
		])
	-%}

	{%- set played_games = profile.widgets | filter(attribute="id", value=widget_id) | first -%}
{%- endif -%}

{%- if token != "NO_TOKEN" and user != "NO_USER" and played_games -%}
	{%- if played_games.data.games | length > 8 -%}
		<input class="visually-hidden" id="show-more" type="checkbox" name="show-more" autocomplete="off" />
		<label for="show-more">
			<span class="more">Show More…</span>
			<span class="less">Show Less…</span>
		</label>
	{%- endif -%}

	<ul>
		{%- for game in played_games.data.games -%}
			{# All games past the first 8 are rendered inside of a separate <ul> #}
			{%- if loop.index == 9 -%}
	</ul>
	<ul class="games-extra">
			{%- endif -%}
			{%- set data = load_data(
				url="https://discord.com/api/v9/applications/public?application_ids=" ~ game.game_id,
				format="json",
				method="GET",
				content_type="application/json",
				headers=[
					"authorization= " ~ token,
					"user-agent= DiscordBot (" ~ config.base_url ~ ", 0.1.0)",
					"x-super-properties= " ~ x_super
				]) | first
			-%}
			{%- set steam = data.third_party_skus | filter(attribute="distributor", value="steam") | first -%}
			
			{# Steam Image Fallback Only - SGDB removed due to API instability with Zola #}
			{%- if steam -%}
			<li>
				<a href="https://store.steampowered.com/app/{{ steam.id }}">
					<img
						class="transparent no-hover"
						alt="Capsule art of {{ data.name }}."
						src="https://shared.steamstatic.com/store_item_assets/steam/apps/{{ steam.id }}/library_600x900.jpg"
						{% if config.markdown.lazy_async_image %}
							decoding="async" loading="lazy"
						{% endif %}
					/>
				</a>
			</li>
			{%- endif -%}
		{%- endfor -%}
	</ul>
{%- else -%}
	<p><em>(Games list unavailable - Discord Token missing or widget not found)</em></p>
	<!-- Fallback or empty list to prevent build errors -->
{%- endif -%}
